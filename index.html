<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-title" content="Christine's Calc">
  <title>Christine's Calc</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #F2F2F7;
      color: #000;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* --- Dark Mode --- */
    @media (prefers-color-scheme: dark) {
      html, body {
        background: #000;
        color: #FFF;
      }
      .card {
        background: #1C1C1E !important;
      }
      .section-header {
        color: #8E8E93 !important;
      }
      .screen-title {
        color: #FFF !important;
      }
      .card input[type="text"],
      .card input[type="number"] {
        background: #2C2C2E !important;
        color: #FFF !important;
        border-color: rgba(255,255,255,0.1) !important;
      }
      .card input::placeholder {
        color: #636366 !important;
      }
      .tab-bar {
        background: rgba(28,28,30,0.85) !important;
        border-top-color: rgba(255,255,255,0.1) !important;
      }
      .total-bar {
        background: rgba(28,28,30,0.92) !important;
        border-top-color: rgba(255,255,255,0.1) !important;
      }
      .separator {
        border-bottom-color: rgba(255,255,255,0.1) !important;
      }
      .surcharge-row {
        border-bottom-color: rgba(255,255,255,0.1) !important;
      }
      .size-btn {
        background: #2C2C2E !important;
        color: #FFF !important;
      }
      .size-btn.active {
        background: #007AFF !important;
        color: #FFF !important;
      }
      .segmented-control {
        background: #2C2C2E !important;
      }
      .dog-entry {
        border-bottom-color: rgba(255,255,255,0.1) !important;
      }
      .history-card {
        background: #1C1C1E !important;
      }
      .empty-state {
        color: #8E8E93 !important;
      }
      .stepper-btn {
        background: #2C2C2E !important;
        color: #FFF !important;
      }
      .expandable-header {
        color: #8E8E93 !important;
      }
    }

    /* --- Screen Management --- */
    .screen {
      display: none;
      padding: 0 16px;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: 170px; /* room for total bar + tab bar */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      z-index: 1;
    }

    .screen.active {
      display: block;
    }

    .screen[data-screen="history"],
    .screen[data-screen="settings"] {
      padding-bottom: 80px; /* only tab bar */
    }

    /* --- Typography --- */
    .screen-title {
      font-size: 34px;
      font-weight: 700;
      color: #000;
      padding: 52px 0 12px 0;
    }

    .section-header {
      font-size: 13px;
      font-weight: 600;
      color: #6D6D72;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      padding: 24px 0 8px 0;
    }

    /* --- Card --- */
    .card {
      background: #FFF;
      border-radius: 12px;
      padding: 0;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      min-height: 44px;
    }

    .card-row + .card-row {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .card-row + .card-row {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .card-row label {
      font-size: 17px;
      flex-shrink: 0;
    }

    /* --- Inputs --- */
    .card input[type="text"],
    .card input[type="number"] {
      font-size: 17px;
      font-family: inherit;
      border: none;
      background: #F2F2F7;
      border-radius: 10px;
      padding: 14px 16px;
      text-align: left;
      width: 100%;
      min-height: 56px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      box-sizing: border-box;
    }

    .card input[type="number"]::-webkit-inner-spin-button,
    .card input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .miles-input {
      font-size: 28px !important;
      font-weight: 600;
      text-align: center !important;
      width: 100% !important;
      padding: 16px 12px !important;
    }

    /* --- Segmented Control --- */
    .segmented-control {
      display: flex;
      background: #E9E9EB;
      border-radius: 8px;
      padding: 2px;
      position: relative;
      width: 100%;
    }

    .segment {
      flex: 1;
      text-align: center;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 7px;
      position: relative;
      z-index: 1;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.2s;
      color: #000;
      -webkit-user-select: none;
      user-select: none;
    }

    @media (prefers-color-scheme: dark) {
      .segment {
        color: #FFF;
      }
    }

    .segment.active {
      background: #FFF;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
    }

    @media (prefers-color-scheme: dark) {
      .segment.active {
        background: #636366;
      }
    }

    /* --- Size Buttons --- */
    .size-buttons {
      display: flex;
      gap: 8px;
    }

    .size-btn {
      flex: 1;
      min-height: 44px;
      min-width: 44px;
      border: none;
      border-radius: 10px;
      background: #F2F2F7;
      font-size: 15px;
      font-weight: 600;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
      -webkit-user-select: none;
      user-select: none;
    }

    .size-btn.active {
      background: #007AFF;
      color: #FFF;
    }

    /* --- Toggle Switch --- */
    .toggle-switch {
      position: relative;
      width: 51px;
      height: 31px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      cursor: pointer;
      z-index: 2;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: #E9E9EB;
      border-radius: 15.5px;
      cursor: pointer;
      transition: background 0.25s;
    }

    .toggle-slider::after {
      content: "";
      position: absolute;
      width: 27px;
      height: 27px;
      background: #FFF;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.25s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
      background: #34C759;
    }

    .toggle-switch input:checked + .toggle-slider::after {
      transform: translateX(20px);
    }

    /* --- Stepper --- */
    .stepper {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .stepper-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: #F2F2F7;
      font-size: 22px;
      font-weight: 400;
      color: #007AFF;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-user-select: none;
      user-select: none;
    }

    .stepper-btn:first-child {
      border-radius: 8px 0 0 8px;
    }

    .stepper-btn:last-child {
      border-radius: 0 8px 8px 0;
    }

    .stepper-value {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 600;
      background: #F2F2F7;
      border-left: 0.5px solid rgba(0,0,0,0.1);
      border-right: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .stepper-btn {
        background: #2C2C2E;
      }
      .stepper-value {
        background: #2C2C2E;
        color: #FFF;
        border-left-color: rgba(255,255,255,0.1);
        border-right-color: rgba(255,255,255,0.1);
      }
    }

    /* --- Dog Entry --- */
    .dog-entry {
      padding: 12px 16px;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
    }

    .dog-entry:last-child {
      border-bottom: none;
    }

    .dog-entry-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .dog-entry-title {
      font-size: 17px;
      font-weight: 600;
    }

    .remove-dog-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: none;
      color: #FF3B30;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .dog-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .dog-field label {
      font-size: 15px;
      color: #3C3C43;
    }

    @media (prefers-color-scheme: dark) {
      .dog-field label {
        color: #EBEBF5;
      }
    }

    .litter-options {
      display: none;
      padding-top: 4px;
    }

    .litter-options.visible {
      display: block;
    }

    /* Age toggle buttons */
    .age-buttons {
      display: flex;
      gap: 8px;
    }

    .age-btn {
      flex: 1;
      min-height: 36px;
      border: none;
      border-radius: 8px;
      background: #F2F2F7;
      font-size: 13px;
      font-weight: 500;
      color: #000;
      cursor: pointer;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-user-select: none;
      user-select: none;
    }

    .age-btn.active {
      background: #007AFF;
      color: #FFF;
    }

    @media (prefers-color-scheme: dark) {
      .age-btn {
        background: #2C2C2E;
        color: #FFF;
      }
      .age-btn.active {
        background: #007AFF;
        color: #FFF;
      }
    }

    /* --- Add Dog Button --- */
    .add-dog-btn {
      width: 100%;
      min-height: 44px;
      border: none;
      background: none;
      color: #007AFF;
      font-size: 17px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 16px;
    }

    /* --- Expandable Section --- */
    .expandable-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      min-height: 44px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      color: #6D6D72;
      font-size: 15px;
      font-weight: 500;
    }

    .expandable-header .chevron {
      transition: transform 0.25s;
      font-size: 13px;
    }

    .expandable-header.expanded .chevron {
      transform: rotate(90deg);
    }

    .expandable-content {
      display: none;
    }

    .expandable-content.visible {
      display: block;
    }

    .surcharge-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      min-height: 44px;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
    }

    .surcharge-row:last-child {
      border-bottom: none;
    }

    .surcharge-row label {
      font-size: 17px;
    }

    .surcharge-detail {
      display: none;
      padding: 0 16px 12px 16px;
    }

    .surcharge-detail.visible {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .surcharge-detail label {
      font-size: 15px;
      color: #3C3C43;
    }

    @media (prefers-color-scheme: dark) {
      .surcharge-detail label {
        color: #EBEBF5;
      }
    }

    .surcharge-detail input[type="number"] {
      width: 100px;
    }

    /* --- Total Bar --- */
    .total-bar {
      position: fixed;
      bottom: calc(56px + env(safe-area-inset-bottom, 0px));
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 0.5px solid rgba(0,0,0,0.1);
      padding: 10px 16px;
      z-index: 100;
      display: none;
    }

    .total-bar.visible {
      display: block;
    }

    .total-amount {
      font-size: 28px;
      font-weight: 700;
      text-align: center;
    }

    .generate-quote-btn {
      display: block;
      width: 100%;
      min-height: 50px;
      border: none;
      border-radius: 12px;
      background: #007AFF;
      color: #FFF;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      font-family: inherit;
    }

    .generate-quote-btn:active {
      opacity: 0.8;
    }

    /* --- Tab Bar --- */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(56px + env(safe-area-inset-bottom, 0px));
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 0.5px solid rgba(0,0,0,0.15);
      display: flex;
      align-items: flex-start;
      justify-content: space-around;
      padding-top: 6px;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      z-index: 200;
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      min-height: 44px;
      border: none;
      background: none;
      cursor: pointer;
      color: #8E8E93;
      font-size: 10px;
      font-weight: 500;
      gap: 2px;
      -webkit-user-select: none;
      user-select: none;
      padding: 2px 8px;
    }

    .tab .tab-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tab .tab-icon svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .tab.active {
      color: #007AFF;
    }

    /* --- History Screen --- */
    .history-card {
      background: #FFF;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 8px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .history-card:active {
      opacity: 0.7;
    }

    .history-card-quote {
      display: none;
      font-size: 13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      white-space: pre-wrap;
      background: #F2F2F7;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      color: #3C3C43;
      line-height: 1.4;
    }

    .history-card-quote.visible {
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .history-card-quote {
        background: #2C2C2E;
        color: #EBEBF5;
      }
    }

    .history-copy-btn {
      display: none;
      width: 100%;
      min-height: 36px;
      border: none;
      border-radius: 8px;
      background: #007AFF;
      color: #FFF;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      font-family: inherit;
    }

    .history-copy-btn.visible {
      display: block;
    }

    .history-copy-btn:active {
      opacity: 0.8;
    }

    .history-card-date {
      font-size: 13px;
      color: #8E8E93;
      margin-bottom: 4px;
    }

    .history-card-summary {
      font-size: 17px;
      font-weight: 400;
      margin-bottom: 2px;
    }

    .history-card-total {
      font-size: 20px;
      font-weight: 700;
    }

    @media (prefers-color-scheme: dark) {
      .history-card-date { color: #8E8E93; }
      .history-card-summary { color: #EBEBF5; }
      .history-card-total { color: #FFF; }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8E8E93;
      font-size: 17px;
    }

    .clear-history-btn {
      display: block;
      width: 100%;
      min-height: 44px;
      border: none;
      background: none;
      color: #FF3B30;
      font-size: 17px;
      cursor: pointer;
      padding: 16px;
      text-align: center;
    }

    /* --- Settings Screen --- */
    .section-footer {
      padding: 6px 16px 12px;
      font-size: 13px;
      color: #8E8E93;
      line-height: 1.35;
    }

    @media (prefers-color-scheme: dark) {
      .section-footer {
        color: #98989D;
      }
    }

    .settings-field {
      padding: 6px 16px;
    }
    .settings-field:first-child {
      padding-top: 12px;
    }
    .settings-field:last-child {
      padding-bottom: 12px;
    }
    .settings-field label {
      display: block;
      font-size: 13px;
      color: #8E8E93;
      margin-bottom: 4px;
      padding-left: 4px;
    }
    .settings-field input[type="number"]::-webkit-inner-spin-button,
    .settings-field input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .reset-defaults-btn {
      display: block;
      width: 100%;
      min-height: 44px;
      border: none;
      background: none;
      color: #FF3B30;
      font-size: 17px;
      cursor: pointer;
      padding: 16px;
      text-align: center;
      margin-top: 12px;
    }

    /* --- Touch Feedback --- */
    .size-btn:active,
    .age-btn:active {
      opacity: 0.6;
    }

    .add-dog-btn:active {
      opacity: 0.6;
    }

    .remove-dog-btn:active {
      background: rgba(255, 59, 48, 0.1);
    }

    .tab:active {
      opacity: 0.6;
    }

    .stepper-btn:active {
      opacity: 0.6;
    }

    .segment:active {
      opacity: 0.6;
    }

    .expandable-header:active {
      opacity: 0.6;
    }

    .toggle-slider:active {
      opacity: 0.8;
    }

    .clear-history-btn:active,
    .reset-defaults-btn:active {
      opacity: 0.6;
    }

    /* --- Customer Field & Auto-suggest --- */
    .customer-input-wrap {
      position: relative;
    }

    .customer-input {
      font-size: 15px;
      font-family: inherit;
      border: none;
      background: #F2F2F7;
      border-radius: 8px;
      padding: 8px 10px;
      width: 100%;
      min-height: 36px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }
    @media (prefers-color-scheme: dark) {
      .customer-input {
        background: #2C2C2E;
        color: #FFF;
      }
      .customer-input::placeholder {
        color: #636366;
      }
    }

    .customer-suggest {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      z-index: 500;
      overflow: hidden;
      max-height: 220px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .customer-suggest.visible {
      display: block;
    }

    .customer-suggest-item {
      padding: 12px 16px;
      min-height: 44px;
      display: flex;
      align-items: center;
      font-size: 17px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .customer-suggest-item + .customer-suggest-item {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    .customer-suggest-item:active {
      background: rgba(0,122,255,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .customer-suggest {
        background: #1C1C1E;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5);
      }
      .customer-suggest-item + .customer-suggest-item {
        border-top-color: rgba(255,255,255,0.1);
      }
      .customer-suggest-item:active {
        background: rgba(0,122,255,0.2);
      }
    }

    /* --- Customers Screen --- */
    .screen[data-screen="customers"] {
      padding-bottom: 80px;
    }

    .customers-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 12px 0;
    }

    .add-customer-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: none;
      color: #007AFF;
      font-size: 28px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      -webkit-user-select: none;
      user-select: none;
    }

    .add-customer-btn:active {
      opacity: 0.6;
    }

    .customer-list-item {
      padding: 14px 16px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .customer-list-item:active {
      opacity: 0.7;
    }

    .customer-list-item + .customer-list-item {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .customer-list-item + .customer-list-item {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .customer-list-name {
      font-size: 17px;
      font-weight: 500;
    }

    .customer-list-notes {
      font-size: 13px;
      color: #8E8E93;
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* --- Customer Detail --- */
    .customer-detail {
      display: none;
    }

    .customer-detail.visible {
      display: block;
    }

    .customer-detail-back {
      border: none;
      background: none;
      color: #007AFF;
      font-size: 17px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      min-height: 44px;
      -webkit-user-select: none;
      user-select: none;
    }

    .customer-detail-back:active {
      opacity: 0.6;
    }

    .customer-detail-input {
      font-size: 17px;
      font-family: inherit;
      border: none;
      background: #F2F2F7;
      border-radius: 8px;
      padding: 10px 12px;
      width: 100%;
      min-height: 44px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .customer-detail-textarea {
      font-size: 17px;
      font-family: inherit;
      border: none;
      background: #F2F2F7;
      border-radius: 8px;
      padding: 10px 12px;
      width: 100%;
      min-height: 88px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      resize: vertical;
    }

    @media (prefers-color-scheme: dark) {
      .customer-detail-input,
      .customer-detail-textarea {
        background: #2C2C2E;
        color: #FFF;
      }
    }

    .delete-customer-btn {
      display: block;
      width: 100%;
      min-height: 44px;
      border: none;
      border-radius: 12px;
      background: none;
      color: #FF3B30;
      font-size: 17px;
      cursor: pointer;
      padding: 16px;
      text-align: center;
      margin-top: 12px;
    }

    .delete-customer-btn:active {
      opacity: 0.6;
    }

    .customer-history-item {
      padding: 10px 0;
    }

    .customer-history-item + .customer-history-item {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .customer-history-item + .customer-history-item {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .customer-history-date {
      font-size: 13px;
      color: #8E8E93;
    }

    .customer-history-summary {
      font-size: 15px;
      margin-top: 2px;
    }

    .customer-history-total {
      font-size: 17px;
      font-weight: 600;
      margin-top: 2px;
    }

    .history-card-customer {
      font-size: 15px;
      font-weight: 500;
      color: #007AFF;
      margin-bottom: 2px;
    }

    /* --- New customer prompt modal --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-card {
      background: #FFF;
      border-radius: 14px;
      width: 100%;
      max-width: 320px;
      overflow: hidden;
      text-align: center;
    }

    .modal-body {
      padding: 20px 16px 16px;
    }

    .modal-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .modal-message {
      font-size: 13px;
      color: #8E8E93;
    }

    .modal-actions {
      display: flex;
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    .modal-btn {
      flex: 1;
      min-height: 44px;
      border: none;
      background: none;
      font-size: 17px;
      cursor: pointer;
      font-family: inherit;
    }

    .modal-btn + .modal-btn {
      border-left: 0.5px solid rgba(0,0,0,0.1);
    }

    .modal-btn-cancel {
      color: #007AFF;
    }

    .modal-btn-confirm {
      color: #007AFF;
      font-weight: 600;
    }

    .modal-btn:active {
      background: rgba(0,0,0,0.05);
    }

    @media (prefers-color-scheme: dark) {
      .modal-card {
        background: #1C1C1E;
      }
      .modal-title {
        color: #FFF;
      }
      .modal-actions {
        border-top-color: rgba(255,255,255,0.1);
      }
      .modal-btn + .modal-btn {
        border-left-color: rgba(255,255,255,0.1);
      }
      .modal-btn:active {
        background: rgba(255,255,255,0.05);
      }
    }
    /* --- Route / Location Fields --- */
    .location-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      min-height: 56px;
    }

    .location-row + .location-row {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .location-row + .location-row {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .location-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .location-dot.origin { background: #34C759; }
    .location-dot.stop { background: #FF9500; }
    .location-dot.dest { background: #FF3B30; }

    .location-input-wrap {
      flex: 1;
      position: relative;
    }


    .route-map-container {
      width: 100%;
      height: 200px;
      display: none;
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }
    .route-map-container.visible {
      display: block;
    }
    #routeMap {
      width: 100%;
      height: 100%;
      border-radius: 0 0 12px 12px;
    }
    @media (prefers-color-scheme: dark) {
      .route-map-container {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    @media (prefers-color-scheme: dark) {
      .location-input {
        background: #2C2C2E;
        color: #FFF;
      }
      .location-input::placeholder {
        color: #636366;
      }
    }

    .location-suggest {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #FFF;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      z-index: 500;
      overflow: hidden;
      max-height: 200px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .location-suggest.visible {
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .location-suggest {
        background: #1C1C1E;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5);
      }
    }

    .location-suggest-item {
      padding: 10px 12px;
      min-height: 44px;
      font-size: 15px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      display: flex;
      align-items: center;
    }

    .location-suggest-item + .location-suggest-item {
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .location-suggest-item + .location-suggest-item {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .location-suggest-item:active {
      background: rgba(0,122,255,0.1);
    }

    .remove-stop-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: #FF3B30;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      border-radius: 50%;
      -webkit-user-select: none;
      user-select: none;
    }

    .remove-stop-btn:active {
      background: rgba(255,59,48,0.1);
    }

    .add-stop-btn {
      width: 100%;
      min-height: 44px;
      border: none;
      background: none;
      color: #007AFF;
      font-size: 15px;
      font-weight: 400;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 16px;
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .add-stop-btn {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .add-stop-btn:active {
      opacity: 0.6;
    }

    /* Miles display row */
    .miles-display-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      min-height: 44px;
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .miles-display-row {
        border-top-color: rgba(255,255,255,0.1);
      }
    }

    .miles-display-label {
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .miles-display-value {
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .miles-mode-btn {
      font-size: 13px;
      color: #007AFF;
      border: none;
      background: none;
      cursor: pointer;
      padding: 4px 8px;
      -webkit-user-select: none;
      user-select: none;
    }

    .miles-mode-btn:active {
      opacity: 0.6;
    }

    .route-summary {
      display: none;
      padding: 8px 16px;
      font-size: 13px;
      color: #8E8E93;
      border-top: 0.5px solid rgba(0,0,0,0.1);
    }

    .route-summary.visible {
      display: block;
    }

    @media (prefers-color-scheme: dark) {
      .route-summary {
        border-top-color: rgba(255,255,255,0.1);
        color: #98989D;
      }
    }

    .route-loading {
      display: none;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #8E8E93;
      padding: 0 16px 8px;
    }

    .route-loading.visible {
      display: flex;
    }

    .route-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #E9E9EB;
      border-top-color: #007AFF;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .route-error {
      display: none;
      font-size: 13px;
      color: #FF3B30;
      padding: 0 16px 8px;
    }

    .route-error.visible {
      display: block;
    }

    .manual-miles-row {
      display: none;
      padding: 8px 16px 12px;
    }

    .manual-miles-row.visible {
      display: block;
    }

    /* --- Quote Notes Textarea --- */
    .quote-notes-textarea {
      font-size: 15px;
      font-family: inherit;
      border: none;
      background: #F2F2F7;
      border-radius: 8px;
      padding: 10px 12px;
      width: 100%;
      min-height: 66px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      resize: vertical;
    }

    @media (prefers-color-scheme: dark) {
      .quote-notes-textarea {
        background: #2C2C2E;
        color: #FFF;
      }
      .quote-notes-textarea::placeholder {
        color: #636366;
      }
    }

    /* --- History Search --- */
    .history-search-wrap {
      margin-bottom: 12px;
    }

    .history-search-input {
      font-size: 17px;
      font-family: inherit;
      border: none;
      background: #E9E9EB;
      border-radius: 10px;
      padding: 10px 12px 10px 36px;
      width: 100%;
      min-height: 36px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
      background-size: 16px;
    }

    @media (prefers-color-scheme: dark) {
      .history-search-input {
        background-color: #1C1C1E;
        color: #FFF;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
      }
      .history-search-input::placeholder {
        color: #636366;
      }
    }

    /* --- Quote Status Pill --- */
    .status-pill {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      vertical-align: middle;
      margin-left: 6px;
    }

    .status-pill:active {
      opacity: 0.6;
    }

    .status-pill-none {
      background: #E9E9EB;
      color: #8E8E93;
    }

    .status-pill-sent {
      background: #8E8E93;
      color: #FFF;
    }

    .status-pill-accepted {
      background: #34C759;
      color: #FFF;
    }

    .status-pill-declined {
      background: #FF3B30;
      color: #FFF;
    }

    @media (prefers-color-scheme: dark) {
      .status-pill-none {
        background: #3A3A3C;
        color: #8E8E93;
      }
    }

    /* --- Re-quote Button --- */
    .history-requote-btn {
      border: none;
      background: none;
      color: #007AFF;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      padding: 0;
      font-family: inherit;
      -webkit-user-select: none;
      user-select: none;
      float: right;
      margin-top: 4px;
    }

    .history-requote-btn:active {
      opacity: 0.6;
    }

    /* --- History Notes Display --- */
    .history-card-notes {
      font-size: 13px;
      color: #8E8E93;
      font-style: italic;
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <!-- ==================== CALCULATOR SCREEN ==================== -->
  <div class="screen active" data-screen="calculator">
    <h1 class="screen-title">Christine's Calc</h1>

    <!-- Route -->
    <div class="section-header">Route</div>
    <div class="card" id="routeCard">
      <div class="location-row" id="originRow">
        <div class="location-dot origin"></div>
        <div class="location-input-wrap">
          <input type="text" class="location-input" id="originInput" placeholder="From (city or address)" autocomplete="off" autocorrect="off" autocapitalize="off">
          <div class="location-suggest" id="originSuggest"></div>
        </div>
      </div>
      <div id="stopsContainer"></div>
      <div class="location-row" id="destRow">
        <div class="location-dot dest"></div>
        <div class="location-input-wrap">
          <input type="text" class="location-input" id="destInput" placeholder="To (city or address)" autocomplete="off" autocorrect="off" autocapitalize="off">
          <div class="location-suggest" id="destSuggest"></div>
        </div>
      </div>
      <button type="button" class="add-stop-btn" id="addStopBtn">+ Add Stop</button>
      <div class="route-summary" id="routeSummary"></div>
      <div class="route-loading" id="routeLoading">
        <div class="route-spinner"></div>
        <span>Calculating route...</span>
      </div>
      <div class="route-error" id="routeError"></div>
      <div class="route-map-container" id="routeMapContainer">
        <div id="routeMap"></div>
      </div>
      <div class="miles-display-row" id="milesDisplayRow">
        <div class="miles-display-label">
          <span>Distance</span>
        </div>
        <div class="miles-display-value">
          <span id="milesValue">0</span> <span>mi</span>
          <button type="button" class="miles-mode-btn" id="milesModeBtn">Auto</button>
        </div>
      </div>
      <div class="manual-miles-row visible" id="manualMilesRow">
        <input type="number" inputmode="numeric" class="miles-input" id="milesInput" placeholder="Enter miles" min="0">
      </div>
    </div>

    <!-- Service Tier -->
    <div class="section-header">Service Tier</div>
    <div class="card">
      <div class="card-row">
        <div class="segmented-control" id="tierControl">
          <div class="segment active" data-tier="economy">Economy</div>
          <div class="segment" data-tier="vip">VIP</div>
        </div>
      </div>
    </div>

    <!-- Dogs -->
    <div class="section-header">Dogs</div>
    <div class="card" id="dogsCard">
      <div id="dogEntries">
        <!-- Dog entries will be added dynamically by JS -->
      </div>
      <button type="button" class="add-dog-btn" id="addDogBtn">+ Add Dog</button>
    </div>

    <!-- Notes -->
    <div class="section-header">Notes</div>
    <div class="card">
      <div class="card-row" style="padding:0;position:relative;">
        <textarea class="quote-notes-textarea" id="quoteNotes" placeholder="Special instructions, dog temperament, pickup details..." maxlength="500"></textarea>
      </div>
      <div class="card-row" style="justify-content:flex-end;padding:4px 16px 8px;min-height:auto;">
        <span id="quoteNotesCount" style="font-size:11px;color:#8E8E93;">0 / 500</span>
      </div>
    </div>

    <!-- Surcharges -->
    <div class="section-header">Surcharges</div>
    <div class="card" id="surchargesCard">
      <div class="expandable-header" id="surchargesHeader">
        <span>Add Surcharges</span>
        <span class="chevron">&#9654;</span>
      </div>
      <div class="expandable-content" id="surchargesContent">
        <!-- Detour -->
        <div class="surcharge-row">
          <label>Detour</label>
          <div class="toggle-switch">
            <input type="checkbox" id="detourToggle">
            <span class="toggle-slider"></span>
          </div>
        </div>
        <div class="surcharge-detail" id="detourDetail">
          <label>Extra miles</label>
          <input type="number" inputmode="numeric" id="detourMiles" placeholder="0" min="0">
        </div>

        <!-- Holiday/Weekend -->
        <div class="surcharge-row">
          <label>Holiday / Weekend</label>
          <div class="toggle-switch">
            <input type="checkbox" id="holidayToggle">
            <span class="toggle-slider"></span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ==================== HISTORY SCREEN ==================== -->
  <div class="screen" data-screen="history">
    <h1 class="screen-title">Quote History</h1>

    <div class="history-search-wrap">
      <input type="text" class="history-search-input" id="historySearch" placeholder="Search quotes..." autocomplete="off">
    </div>

    <div id="historyList">
      <div class="empty-state" id="historyEmpty">No quotes yet</div>
    </div>

    <button type="button" class="clear-history-btn" id="clearHistoryBtn">Clear History</button>
  </div>

  <!-- ==================== CUSTOMERS SCREEN ==================== -->
  <div class="screen" data-screen="customers">
    <!-- Customer List View -->
    <div id="customerListView">
      <div class="customers-header-row">
        <h1 class="screen-title" style="padding-bottom:0;">Customers</h1>
        <button type="button" class="add-customer-btn" id="addCustomerBtn">+</button>
      </div>
      <div id="customerList">
        <div class="empty-state" id="customersEmpty">No customers yet</div>
      </div>
    </div>

    <!-- Customer Detail View -->
    <div class="customer-detail" id="customerDetailView">
      <button type="button" class="customer-detail-back" id="customerBackBtn">
        <svg width="10" height="17" viewBox="0 0 10 17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9,1 1,8.5 9,16"/></svg>
        Customers
      </button>
      <h1 class="screen-title" id="customerDetailTitle">Customer</h1>

      <div class="section-header">Name</div>
      <div class="card">
        <div class="card-row" style="padding:0;">
          <input type="text" class="customer-detail-input" id="customerDetailName" placeholder="Customer name">
        </div>
      </div>

      <div class="section-header">Notes</div>
      <div class="card">
        <div class="card-row" style="padding:0;">
          <textarea class="customer-detail-textarea" id="customerDetailNotes" placeholder="Notes about this customer"></textarea>
        </div>
      </div>

      <div class="section-header">Quote History</div>
      <div class="card" id="customerQuotesCard">
        <div class="empty-state" id="customerQuotesEmpty" style="padding:24px 16px;">No quotes for this customer</div>
      </div>

      <button type="button" class="delete-customer-btn" id="deleteCustomerBtn">Delete Customer</button>
    </div>
  </div>

  <!-- ==================== SETTINGS SCREEN ==================== -->
  <div class="screen" data-screen="settings">
    <h1 class="screen-title">Settings</h1>

    <!-- Business Info -->
    <div class="section-header">Business Info</div>
    <div class="card">
      <div class="settings-field">
        <label>Business Name</label>
        <input type="text" id="settingBusinessName" placeholder="Your business name">
      </div>
    </div>
    <div class="section-footer">Appears at the bottom of quotes you copy and send to customers.</div>

    <!-- Base Rates -->
    <div class="section-header">Base Rates</div>
    <div class="card">
      <div class="settings-field">
        <label>Base Fee ($)</label>
        <input type="number" inputmode="decimal" id="settingBaseFee" value="200" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Per-Mile Rate ($/mi)</label>
        <input type="number" inputmode="decimal" id="settingPerMile" value="1.00" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Sanitation Fee ($)</label>
        <input type="number" inputmode="decimal" id="settingSanitation" value="35" min="0" step="any">
      </div>
    </div>
    <div class="section-footer">Charged on every booking. Base fee covers admin, loading, and insurance. Sanitation covers vehicle cleaning.</div>

    <!-- Size Surcharges -->
    <div class="section-header">Size Surcharges</div>
    <div class="card">
      <div class="settings-field">
        <label>Small — under 25 lbs ($)</label>
        <input type="number" inputmode="decimal" id="settingSizeSmall" value="0" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Medium — 25-50 lbs ($)</label>
        <input type="number" inputmode="decimal" id="settingSizeMedium" value="25" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Large — 50-80 lbs ($)</label>
        <input type="number" inputmode="decimal" id="settingSizeLarge" value="50" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>XL — 80+ lbs ($)</label>
        <input type="number" inputmode="decimal" id="settingSizeXL" value="100" min="0" step="any">
      </div>
    </div>
    <div class="section-footer">Extra charge per dog based on weight. Added on top of the base fee for each dog.</div>

    <!-- Litter Rates -->
    <div class="section-header">Litter Rates</div>
    <div class="card">
      <div class="settings-field">
        <label>Under 16 wks ($/ea)</label>
        <input type="number" inputmode="decimal" id="settingLitterUnder16" value="75" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Over 16 wks ($/ea)</label>
        <input type="number" inputmode="decimal" id="settingLitterOver16" value="100" min="0" step="any">
      </div>
    </div>
    <div class="section-footer">Flat rate per sibling puppy from the same litter. The first puppy pays full price; siblings get this discounted rate.</div>

    <!-- VIP Rates -->
    <div class="section-header">VIP Rates</div>
    <div class="card">
      <div class="settings-field">
        <label>Base Multiplier (x)</label>
        <input type="number" inputmode="decimal" id="settingVipMultiplier" value="2" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Per-Mile Adder ($/mi)</label>
        <input type="number" inputmode="decimal" id="settingVipPerMile" value="2.00" min="0" step="any">
      </div>
    </div>
    <div class="section-footer">Private ride, no other dogs in the van. Base fee is multiplied (2x = double), and extra per-mile rate is added on top of the standard rate.</div>

    <!-- Surcharge Rates -->
    <div class="section-header">Surcharge Rates</div>
    <div class="card">
      <div class="settings-field">
        <label>Detour Rate ($/mi)</label>
        <input type="number" inputmode="decimal" id="settingDetourPerMile" value="1.50" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Detour Threshold (mi)</label>
        <input type="number" inputmode="decimal" id="settingDetourThreshold" value="30" min="0" step="any">
      </div>
      <div class="settings-field">
        <label>Holiday Surcharge (%)</label>
        <input type="number" inputmode="decimal" id="settingHolidayPercent" value="20" min="0" step="any">
      </div>
    </div>
    <div class="section-footer">Detour charges apply per extra mile beyond the threshold. Holiday adds a percentage to the total.</div>

    <button type="button" class="reset-defaults-btn" id="resetDefaultsBtn">Reset to Defaults</button>
  </div>

  <!-- ==================== TOTAL BAR (Calculator only) ==================== -->
  <div class="total-bar visible" id="totalBar">
    <div class="total-amount" id="totalAmount">$0.00</div>
    <button type="button" class="generate-quote-btn" id="generateQuoteBtn">Generate Quote</button>
  </div>

  <!-- ==================== TAB BAR ==================== -->
  <nav class="tab-bar">
    <button type="button" class="tab active" data-screen="calculator">
      <span class="tab-icon"><svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="7" x2="16" y2="7"/><line x1="8" y1="11" x2="16" y2="11"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="8" y1="19" x2="16" y2="19"/></svg></span>
      <span>Calculator</span>
    </button>
    <button type="button" class="tab" data-screen="history">
      <span class="tab-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><polyline points="12,7 12,12 16,14"/></svg></span>
      <span>History</span>
    </button>
    <button type="button" class="tab" data-screen="customers">
      <span class="tab-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg></span>
      <span>Customers</span>
    </button>
    <button type="button" class="tab" data-screen="settings">
      <span class="tab-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
      <span>Settings</span>
    </button>
  </nav>

  <!-- ==================== NEW CUSTOMER MODAL ==================== -->
  <div class="modal-overlay" id="newCustomerModal">
    <div class="modal-card">
      <div class="modal-body">
        <div class="modal-title">Save New Customer?</div>
        <div class="modal-message" id="newCustomerModalName"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn modal-btn-cancel" id="newCustomerModalCancel">Not Now</button>
        <button type="button" class="modal-btn modal-btn-confirm" id="newCustomerModalSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ===================== DEFAULT SETTINGS =====================
    const DEFAULTS = {
      businessName: '',
      baseFee: 200, perMile: 1.00, sanitation: 35,
      sizeSmall: 0, sizeMedium: 25, sizeLarge: 50, sizeXL: 100,
      litterUnder16: 75, litterOver16: 100,
      vipMultiplier: 2, vipPerMile: 2.00,
      detourPerMile: 1.50, detourThreshold: 30,
      holidayPercent: 20
    };

    const SETTINGS_KEY = 'dogcalc_settings';
    const HISTORY_KEY = 'dogcalc_history';
    const CUSTOMERS_KEY = 'dogcalc_customers';

    // Map setting keys to input element IDs
    const SETTING_IDS = {
      businessName: 'settingBusinessName',
      baseFee: 'settingBaseFee',
      perMile: 'settingPerMile',
      sanitation: 'settingSanitation',
      sizeSmall: 'settingSizeSmall',
      sizeMedium: 'settingSizeMedium',
      sizeLarge: 'settingSizeLarge',
      sizeXL: 'settingSizeXL',
      litterUnder16: 'settingLitterUnder16',
      litterOver16: 'settingLitterOver16',
      vipMultiplier: 'settingVipMultiplier',
      vipPerMile: 'settingVipPerMile',
      detourPerMile: 'settingDetourPerMile',
      detourThreshold: 'settingDetourThreshold',
      holidayPercent: 'settingHolidayPercent'
    };

    // ===================== SETTINGS PERSISTENCE =====================
    function loadSettings() {
      let saved = {};
      try { saved = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; } catch(e) {}
      for (const [key, id] of Object.entries(SETTING_IDS)) {
        const el = document.getElementById(id);
        if (!el) continue;
        const val = saved[key] !== undefined ? saved[key] : DEFAULTS[key];
        el.value = val;
      }
    }

    function saveSettings() {
      const settings = {};
      for (const [key, id] of Object.entries(SETTING_IDS)) {
        const el = document.getElementById(id);
        if (!el) continue;
        settings[key] = key === 'businessName' ? el.value : parseFloat(el.value) || 0;
      }
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function getSetting(key) {
      const el = document.getElementById(SETTING_IDS[key]);
      if (!el) return DEFAULTS[key];
      if (key === 'businessName') return el.value;
      return parseFloat(el.value) || 0;
    }

    function resetDefaults() {
      for (const [key, id] of Object.entries(SETTING_IDS)) {
        const el = document.getElementById(id);
        if (!el) continue;
        el.value = DEFAULTS[key];
      }
      saveSettings();
      recalculate();
    }

    // ===================== CUSTOMER DATA =====================
    function loadCustomers() {
      try { return JSON.parse(localStorage.getItem(CUSTOMERS_KEY)) || []; } catch(e) { return []; }
    }

    function saveCustomers(customers) {
      localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers));
    }

    function addCustomer(name, notes) {
      const customers = loadCustomers();
      const customer = { id: Date.now(), name: name, notes: notes || '', createdAt: new Date().toISOString() };
      customers.push(customer);
      saveCustomers(customers);
      return customer;
    }

    function deleteCustomer(id) {
      let customers = loadCustomers();
      customers = customers.filter(c => c.id !== id);
      saveCustomers(customers);
    }

    function updateCustomer(id, name, notes) {
      const customers = loadCustomers();
      const c = customers.find(c => c.id === id);
      if (c) {
        c.name = name;
        c.notes = notes;
        saveCustomers(customers);
      }
    }

    // Track selected customer on calculator

    // ===================== TAB NAVIGATION =====================
    const tabs = document.querySelectorAll('.tab[data-screen]');
    const screens = document.querySelectorAll('.screen[data-screen]');
    const totalBar = document.getElementById('totalBar');

    function switchScreen(name) {
      screens.forEach(s => s.classList.toggle('active', s.dataset.screen === name));
      tabs.forEach(t => t.classList.toggle('active', t.dataset.screen === name));
      totalBar.classList.toggle('visible', name === 'calculator');
      if (name === 'history') renderHistory();
      if (name === 'customers') {
        renderCustomerList();
        showCustomerList();
      }
      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen) activeScreen.scrollTop = 0;
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchScreen(tab.dataset.screen));
    });

    // ===================== DOG MANAGEMENT =====================
    let dogCounter = 0;

    function createDogEntry() {
      dogCounter++;
      const idx = dogCounter;
      const entry = document.createElement('div');
      entry.className = 'dog-entry';
      entry.dataset.dogId = idx;
      entry.innerHTML = `
        <div class="dog-entry-header">
          <span class="dog-entry-title">Dog ${idx}</span>
          <button type="button" class="remove-dog-btn" data-remove="${idx}">&times;</button>
        </div>
        <div class="dog-field">
          <label>Customer</label>
          <div class="customer-input-wrap">
            <input type="text" class="customer-input" data-dog-customer="${idx}" placeholder="Customer name" autocomplete="off">
            <div class="customer-suggest" data-dog-suggest="${idx}"></div>
          </div>
        </div>
        <div class="dog-field">
          <label>Size</label>
          <div class="size-buttons">
            <button type="button" class="size-btn active" data-size="S">S</button>
            <button type="button" class="size-btn" data-size="M">M</button>
            <button type="button" class="size-btn" data-size="L">L</button>
            <button type="button" class="size-btn" data-size="XL">XL</button>
          </div>
        </div>
        <div class="dog-field">
          <label>Litter</label>
          <div class="toggle-switch">
            <input type="checkbox" class="litter-toggle" data-dog="${idx}">
            <span class="toggle-slider"></span>
          </div>
        </div>
        <div class="litter-options" data-litter-options="${idx}">
          <div class="dog-field">
            <label>Siblings</label>
            <div class="stepper">
              <button type="button" class="stepper-btn" data-action="decrement" data-stepper="siblings-${idx}">&minus;</button>
              <span class="stepper-value" id="siblings-${idx}">1</span>
              <button type="button" class="stepper-btn" data-action="increment" data-stepper="siblings-${idx}">+</button>
            </div>
          </div>
          <div class="dog-field">
            <label>Age</label>
            <div class="age-buttons">
              <button type="button" class="age-btn active" data-age="under16">Under 16 wks</button>
              <button type="button" class="age-btn" data-age="over16">Over 16 wks</button>
            </div>
          </div>
        </div>
      `;

      // Size buttons
      entry.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          entry.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          recalculate();
        });
      });

      // Litter toggle
      const litterToggle = entry.querySelector('.litter-toggle');
      const litterOpts = entry.querySelector(`[data-litter-options="${idx}"]`);
      litterToggle.addEventListener('change', () => {
        litterOpts.classList.toggle('visible', litterToggle.checked);
        recalculate();
      });

      // Age buttons
      entry.querySelectorAll('.age-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          entry.querySelectorAll('.age-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          recalculate();
        });
      });

      // Remove button
      entry.querySelector('.remove-dog-btn').addEventListener('click', () => {
        entry.remove();
        renumberDogs();
        recalculate();
      });

      // Customer auto-suggest
      const custInput = entry.querySelector(`[data-dog-customer="${idx}"]`);
      const custSuggest = entry.querySelector(`[data-dog-suggest="${idx}"]`);
      custInput.addEventListener('input', () => {
        const query = custInput.value.trim().toLowerCase();
        if (!query) { custSuggest.classList.remove('visible'); return; }
        const customers = loadCustomers();
        const matches = customers.filter(c => c.name.toLowerCase().includes(query));
        if (matches.length === 0) { custSuggest.classList.remove('visible'); return; }
        custSuggest.innerHTML = '';
        matches.forEach(c => {
          const item = document.createElement('div');
          item.className = 'customer-suggest-item';
          item.textContent = c.name;
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            custInput.value = c.name;
            custSuggest.classList.remove('visible');
          });
          custSuggest.appendChild(item);
        });
        custSuggest.classList.add('visible');
      });

      document.getElementById('dogEntries').appendChild(entry);
      recalculate();
      return entry;
    }

    function renumberDogs() {
      const entries = document.querySelectorAll('#dogEntries .dog-entry');
      entries.forEach((entry, i) => {
        entry.querySelector('.dog-entry-title').textContent = `Dog ${i + 1}`;
      });
    }

    function getDogData() {
      const dogs = [];
      document.querySelectorAll('#dogEntries .dog-entry').forEach(entry => {
        const activeSize = entry.querySelector('.size-btn.active');
        const size = activeSize ? activeSize.dataset.size : 'S';
        const isLitter = entry.querySelector('.litter-toggle').checked;
        const siblingsEl = entry.querySelector('.stepper-value');
        const siblingCount = parseInt(siblingsEl.textContent) || 1;
        const activeAge = entry.querySelector('.age-btn.active');
        const age = activeAge ? activeAge.dataset.age : 'under16';
        const custEl = entry.querySelector('.customer-input');
        const customer = custEl ? custEl.value.trim() : '';
        dogs.push({ size, isLitter, siblingCount, age, customer });
      });
      return dogs;
    }

    document.getElementById('addDogBtn').addEventListener('click', createDogEntry);

    // ===================== STEPPER LOGIC =====================
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.stepper-btn');
      if (!btn) return;
      const targetId = btn.dataset.target || btn.dataset.stepper;
      if (!targetId) return;
      const valueEl = document.getElementById(targetId);
      if (!valueEl) return;
      let val = parseInt(valueEl.textContent) || 1;
      if (btn.dataset.action === 'increment') val++;
      if (btn.dataset.action === 'decrement' && val > 1) val--;
      valueEl.textContent = val;
      recalculate();
    });

    // ===================== SURCHARGES EXPANDABLE =====================
    const surchargesHeader = document.getElementById('surchargesHeader');
    const surchargesContent = document.getElementById('surchargesContent');

    surchargesHeader.addEventListener('click', () => {
      surchargesHeader.classList.toggle('expanded');
      surchargesContent.classList.toggle('visible');
    });

    // Surcharge toggle -> show/hide detail
    function setupSurchargeToggle(toggleId, detailId) {
      const toggle = document.getElementById(toggleId);
      const detail = document.getElementById(detailId);
      if (!toggle || !detail) return;
      toggle.addEventListener('change', () => {
        detail.classList.toggle('visible', toggle.checked);
        recalculate();
      });
    }

    setupSurchargeToggle('detourToggle', 'detourDetail');

    // Holiday has no detail, just recalculate
    document.getElementById('holidayToggle').addEventListener('change', recalculate);

    // ===================== TIER SEGMENTED CONTROL =====================
    const tierControl = document.getElementById('tierControl');
    tierControl.querySelectorAll('.segment').forEach(seg => {
      seg.addEventListener('click', () => {
        tierControl.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
        seg.classList.add('active');
        recalculate();
      });
    });

    function getActiveTier() {
      const active = tierControl.querySelector('.segment.active');
      return active ? active.dataset.tier : 'economy';
    }

    // ===================== PRICING ENGINE =====================
    function getSizeSurcharge(size) {
      switch(size) {
        case 'S': return getSetting('sizeSmall');
        case 'M': return getSetting('sizeMedium');
        case 'L': return getSetting('sizeLarge');
        case 'XL': return getSetting('sizeXL');
        default: return 0;
      }
    }

    function calculateTotal() {
      const miles = parseFloat(document.getElementById('milesInput').value) || 0;
      const tier = getActiveTier();
      const dogs = getDogData();

      const baseFee = getSetting('baseFee');
      const perMile = getSetting('perMile');
      const sanitation = getSetting('sanitation');
      const vipMultiplier = getSetting('vipMultiplier');
      const vipPerMile = getSetting('vipPerMile');

      let total = 0;

      // Calculate per-dog costs
      dogs.forEach(dog => {
        let dogBase, dogMileage;
        if (tier === 'vip') {
          dogBase = baseFee * vipMultiplier;
          dogMileage = miles * (perMile + vipPerMile);
        } else {
          dogBase = baseFee;
          dogMileage = miles * perMile;
        }
        const sizeSurcharge = getSizeSurcharge(dog.size);
        // First dog (or non-litter) gets full rate
        total += dogBase + dogMileage + sizeSurcharge + sanitation;

        // Litter siblings
        if (dog.isLitter && dog.siblingCount > 1) {
          const litterRate = dog.age === 'under16'
            ? getSetting('litterUnder16')
            : getSetting('litterOver16');
          total += (dog.siblingCount - 1) * litterRate;
        }
      });

      // Surcharges
      // Detour
      if (document.getElementById('detourToggle').checked) {
        const detourMiles = parseFloat(document.getElementById('detourMiles').value) || 0;
        const threshold = getSetting('detourThreshold');
        const detourRate = getSetting('detourPerMile');
        if (detourMiles > threshold) {
          total += (detourMiles - threshold) * detourRate;
        }
      }

      // Holiday % — applied LAST as percentage of subtotal
      if (document.getElementById('holidayToggle').checked) {
        total += total * (getSetting('holidayPercent') / 100);
      }

      return total;
    }

    function recalculate() {
      const total = calculateTotal();
      document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
    }

    // Live recalculation on input changes
    document.getElementById('detourMiles').addEventListener('input', recalculate);

    // Notes character count
    document.getElementById('quoteNotes').addEventListener('input', () => {
      const len = document.getElementById('quoteNotes').value.length;
      document.getElementById('quoteNotesCount').textContent = len + ' / 500';
    });

    // Settings inputs also trigger recalculate
    for (const id of Object.values(SETTING_IDS)) {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          saveSettings();
          recalculate();
        });
      }
    }

    // ===================== CUSTOMER AUTO-SUGGEST =====================
    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.customer-input-wrap')) {
        document.querySelectorAll('.customer-suggest').forEach(s => s.classList.remove('visible'));
      }
    });

    // ===================== ROUTE / AUTO-MILEAGE =====================
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';
    const OSRM_URL = 'https://router.project-osrm.org/route/v1/driving';

    // Route state
    let routeWaypoints = []; // [{lat, lon, name}] — origin, stops..., dest
    let originCoords = null; // {lat, lon, name}
    let destCoords = null;
    let stopCoords = [];     // [{lat, lon, name}]
    let milesMode = 'manual';  // 'auto' or 'manual'
    let geocodeTimers = {};

    // Nominatim geocoding with debounce
    function geocodeLocation(query, callback) {
      const url = `${NOMINATIM_URL}?q=${encodeURIComponent(query)}&format=json&limit=5&countrycodes=us`;
      fetch(url, {
        headers: { 'Accept': 'application/json', 'User-Agent': 'Christine's Calc/1.0' }
      })
      .then(r => r.json())
      .then(results => {
        callback(results.map(r => ({
          lat: parseFloat(r.lat),
          lon: parseFloat(r.lon),
          name: r.display_name
        })));
      })
      .catch(() => callback([]));
    }

    // OSRM routing
    function calculateRoute() {
      const waypoints = [];
      if (originCoords) waypoints.push(originCoords);
      stopCoords.forEach(s => { if (s) waypoints.push(s); });
      if (destCoords) waypoints.push(destCoords);

      if (waypoints.length < 2) return;

      // Show loading
      document.getElementById('routeLoading').classList.add('visible');
      document.getElementById('routeError').classList.remove('visible');

      const coords = waypoints.map(w => `${w.lon},${w.lat}`).join(';');
      const url = `${OSRM_URL}/${coords}?overview=full&geometries=geojson`;

      fetch(url)
      .then(r => r.json())
      .then(data => {
        document.getElementById('routeLoading').classList.remove('visible');
        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
          const meters = data.routes[0].distance;
          const miles = Math.round(meters * 0.000621371);
          // Auto-switch to auto mode on successful route
          milesMode = 'auto';
          document.getElementById('milesModeBtn').textContent = 'Edit';
          document.getElementById('manualMilesRow').classList.remove('visible');
          document.getElementById('milesInput').value = miles;
          document.getElementById('milesValue').textContent = miles;
          recalculate();
          // Show route on map
          showRouteMap(waypoints, data.routes[0].geometry);
        } else {
          document.getElementById('routeError').textContent = 'Could not calculate route';
          document.getElementById('routeError').classList.add('visible');
          hideRouteMap();
        }
      })
      .catch(() => {
        document.getElementById('routeLoading').classList.remove('visible');
        document.getElementById('routeError').textContent = 'Route calculation failed — check connection';
        document.getElementById('routeError').classList.add('visible');
        hideRouteMap();
      });
    }

    // ===================== ROUTE MAP =====================
    let routeMap = null;
    let routeLayer = null;
    let markerLayer = null;

    function showRouteMap(waypoints, geometry) {
      const container = document.getElementById('routeMapContainer');
      container.classList.add('visible');

      if (!routeMap) {
        routeMap = L.map('routeMap', {
          zoomControl: false,
          attributionControl: false,
          dragging: true,
          touchZoom: true,
          scrollWheelZoom: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18
        }).addTo(routeMap);
      }

      // Clear previous layers
      if (routeLayer) { routeMap.removeLayer(routeLayer); routeLayer = null; }
      if (markerLayer) { routeMap.removeLayer(markerLayer); markerLayer = null; }

      // Draw route line
      const routeCoords = geometry.coordinates.map(c => [c[1], c[0]]);
      routeLayer = L.polyline(routeCoords, { color: '#007AFF', weight: 4, opacity: 0.8 }).addTo(routeMap);

      // Add markers for waypoints
      markerLayer = L.layerGroup().addTo(routeMap);
      const colors = { origin: '#34C759', stop: '#FF9500', dest: '#FF3B30' };
      waypoints.forEach((wp, i) => {
        const type = i === 0 ? 'origin' : i === waypoints.length - 1 ? 'dest' : 'stop';
        const color = colors[type];
        const marker = L.circleMarker([wp.lat, wp.lon], {
          radius: 8,
          fillColor: color,
          color: '#FFF',
          weight: 2,
          fillOpacity: 1
        });
        if (wp.name) marker.bindTooltip(wp.name.split(',')[0], { direction: 'top', offset: [0, -8] });
        markerLayer.addLayer(marker);
      });

      // Fit bounds
      routeMap.fitBounds(routeLayer.getBounds(), { padding: [30, 30] });
      setTimeout(() => routeMap.invalidateSize(), 100);
    }

    function hideRouteMap() {
      document.getElementById('routeMapContainer').classList.remove('visible');
    }

    // Setup location input with suggestions
    function setupLocationInput(inputId, suggestId, onSelect) {
      const input = document.getElementById(inputId);
      const suggest = document.getElementById(suggestId);

      input.addEventListener('input', () => {
        const query = input.value.trim();
        if (geocodeTimers[inputId]) clearTimeout(geocodeTimers[inputId]);

        if (query.length < 3) {
          suggest.classList.remove('visible');
          return;
        }

        geocodeTimers[inputId] = setTimeout(() => {
          geocodeLocation(query, (results) => {
            if (results.length === 0) {
              suggest.classList.remove('visible');
              return;
            }
            suggest.innerHTML = '';
            results.forEach(r => {
              const item = document.createElement('div');
              item.className = 'location-suggest-item';
              // Shorten display name
              const parts = r.name.split(', ');
              const short = parts.length > 3 ? parts.slice(0, 3).join(', ') : r.name;
              item.textContent = short;
              item.addEventListener('click', (e) => {
                e.stopPropagation();
                input.value = short;
                suggest.classList.remove('visible');
                onSelect({ lat: r.lat, lon: r.lon, name: short });
              });
              suggest.appendChild(item);
            });
            suggest.classList.add('visible');
          });
        }, 500);
      });

      // Hide on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest(`#${inputId}`) && !e.target.closest(`#${suggestId}`)) {
          suggest.classList.remove('visible');
        }
      });
    }

    setupLocationInput('originInput', 'originSuggest', (coords) => {
      originCoords = coords;
      updateRouteSummary();
      calculateRoute();
    });

    setupLocationInput('destInput', 'destSuggest', (coords) => {
      destCoords = coords;
      updateRouteSummary();
      calculateRoute();
    });

    // Stops management
    let stopCounter = 0;

    function updateAddStopBtn() {
      const activeStops = document.querySelectorAll('#stopsContainer .location-row').length;
      document.getElementById('addStopBtn').style.display = activeStops >= 5 ? 'none' : '';
    }

    document.getElementById('addStopBtn').addEventListener('click', () => {
      const activeStops = document.querySelectorAll('#stopsContainer .location-row').length;
      if (activeStops >= 5) return;

      stopCounter++;
      const idx = stopCounter;
      const stopIdx = stopCoords.length;
      stopCoords.push(null);

      const container = document.getElementById('stopsContainer');
      const row = document.createElement('div');
      row.className = 'location-row';
      row.dataset.stopIdx = stopIdx;
      row.innerHTML = `
        <div class="location-dot stop"></div>
        <div class="location-input-wrap">
          <input type="text" class="location-input" id="stopInput${idx}" placeholder="Stop (city or address)" autocomplete="off" autocorrect="off" autocapitalize="off">
          <div class="location-suggest" id="stopSuggest${idx}"></div>
        </div>
        <button type="button" class="remove-stop-btn" data-stop-idx="${stopIdx}">&times;</button>
      `;

      container.appendChild(row);

      setupLocationInput(`stopInput${idx}`, `stopSuggest${idx}`, (coords) => {
        const si = parseInt(row.dataset.stopIdx);
        stopCoords[si] = coords;
        updateRouteSummary();
        calculateRoute();
      });

      row.querySelector('.remove-stop-btn').addEventListener('click', () => {
        const si = parseInt(row.dataset.stopIdx);
        stopCoords[si] = null;
        row.remove();
        reindexStops();
        updateAddStopBtn();
        updateRouteSummary();
        calculateRoute();
      });

      updateAddStopBtn();
    });

    function reindexStops() {
      // Clean out null entries from removed stops
      stopCoords = stopCoords.filter(s => s !== null);
      const rows = document.querySelectorAll('#stopsContainer .location-row');
      rows.forEach((row, i) => {
        row.dataset.stopIdx = i;
        const removeBtn = row.querySelector('.remove-stop-btn');
        if (removeBtn) removeBtn.dataset.stopIdx = i;
      });
    }

    // Route summary display
    function updateRouteSummary() {
      const summary = document.getElementById('routeSummary');
      const names = [];
      if (originCoords) names.push(originCoords.name.split(',')[0]);
      stopCoords.forEach(s => { if (s) names.push(s.name.split(',')[0]); });
      if (destCoords) names.push(destCoords.name.split(',')[0]);

      if (names.length >= 2) {
        summary.textContent = names.join(' → ');
        summary.classList.add('visible');
      } else {
        summary.classList.remove('visible');
      }
    }

    // Miles mode toggle (auto vs manual)
    const milesModeBtn = document.getElementById('milesModeBtn');
    const manualMilesRow = document.getElementById('manualMilesRow');

    milesModeBtn.addEventListener('click', () => {
      if (milesMode === 'auto') {
        milesMode = 'manual';
        milesModeBtn.textContent = 'Auto';
        manualMilesRow.classList.add('visible');
      } else {
        milesMode = 'auto';
        milesModeBtn.textContent = 'Edit';
        manualMilesRow.classList.remove('visible');
        // Re-trigger route calc if we have coordinates
        if (originCoords && destCoords) {
          calculateRoute();
        }
      }
    });

    // Keep milesValue display in sync with milesInput
    document.getElementById('milesInput').addEventListener('input', () => {
      const val = document.getElementById('milesInput').value || '0';
      document.getElementById('milesValue').textContent = val;
      recalculate();
    });

    // ===================== CLIPBOARD HELPER =====================
    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text);
      }
      // Fallback for file:// URLs
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      return Promise.resolve();
    }

    // ===================== GENERATE QUOTE =====================
    document.getElementById('generateQuoteBtn').addEventListener('click', () => {
      const miles = parseFloat(document.getElementById('milesInput').value) || 0;
      const tier = getActiveTier();
      const dogs = getDogData();
      const total = calculateTotal();
      const businessName = getSetting('businessName');

      const baseFee = getSetting('baseFee');
      const perMile = getSetting('perMile');
      const sanitation = getSetting('sanitation');
      const vipMultiplier = getSetting('vipMultiplier');
      const vipPerMile = getSetting('vipPerMile');

      // Collect unique customer names from dogs
      const customerNames = [...new Set(dogs.map(d => d.customer).filter(Boolean))];

      let lines = [];
      if (businessName) lines.push(businessName);
      lines.push('Transport Quote');
      if (customerNames.length === 1) lines.push(`Customer: ${customerNames[0]}`);
      else if (customerNames.length > 1) lines.push(`Customers: ${customerNames.join(', ')}`);
      const originName = document.getElementById('originInput').value.trim();
      const destName = document.getElementById('destInput').value.trim();

      // Build route names for quote
      const routeNames = [];
      if (originName) routeNames.push(originName.split(',')[0]);
      stopCoords.forEach(s => { if (s) routeNames.push(s.name.split(',')[0]); });
      if (destName) routeNames.push(destName.split(',')[0]);

      lines.push('─'.repeat(28));
      if (routeNames.length >= 2) {
        lines.push(`Trip: ${routeNames.join(' → ')} (${miles} miles, ${tier === 'vip' ? 'VIP' : 'Economy'})`);
      } else {
        lines.push(`Service: ${tier === 'vip' ? 'VIP' : 'Economy'}`);
        lines.push(`Distance: ${miles} miles`);
      }
      lines.push('');

      dogs.forEach((dog, i) => {
        let dogBase, dogMileage;
        if (tier === 'vip') {
          dogBase = baseFee * vipMultiplier;
          dogMileage = miles * (perMile + vipPerMile);
        } else {
          dogBase = baseFee;
          dogMileage = miles * perMile;
        }
        const sizeSurcharge = getSizeSurcharge(dog.size);
        const sizeLabel = {S:'Small',M:'Medium',L:'Large',XL:'XL'}[dog.size] || dog.size;
        const custLabel = dog.customer ? ` — ${dog.customer}` : '';
        lines.push(`Dog ${i+1} (${sizeLabel})${custLabel}:`);
        lines.push(`  Base fee: $${dogBase.toFixed(2)}`);
        lines.push(`  Mileage: $${dogMileage.toFixed(2)}`);
        if (sizeSurcharge > 0) lines.push(`  Size surcharge: $${sizeSurcharge.toFixed(2)}`);
        lines.push(`  Sanitation: $${sanitation.toFixed(2)}`);

        if (dog.isLitter && dog.siblingCount > 1) {
          const litterRate = dog.age === 'under16'
            ? getSetting('litterUnder16')
            : getSetting('litterOver16');
          const siblingTotal = (dog.siblingCount - 1) * litterRate;
          const ageLabel = dog.age === 'under16' ? 'under 16 wks' : 'over 16 wks';
          lines.push(`  Litter: ${dog.siblingCount - 1} sibling(s) (${ageLabel}) @ $${litterRate.toFixed(2)} = $${siblingTotal.toFixed(2)}`);
        }
        lines.push('');
      });

      // Surcharges
      let hasSurcharges = false;
      if (document.getElementById('detourToggle').checked) {
        const detourMiles = parseFloat(document.getElementById('detourMiles').value) || 0;
        const threshold = getSetting('detourThreshold');
        const detourRate = getSetting('detourPerMile');
        if (detourMiles > threshold) {
          if (!hasSurcharges) { lines.push('Surcharges:'); hasSurcharges = true; }
          const detourFee = (detourMiles - threshold) * detourRate;
          lines.push(`  Detour: ${detourMiles} mi (${detourMiles - threshold} mi over threshold) = $${detourFee.toFixed(2)}`);
        }
      }
      if (document.getElementById('holidayToggle').checked) {
        const pct = getSetting('holidayPercent');
        if (!hasSurcharges) { lines.push('Surcharges:'); hasSurcharges = true; }
        // Calculate subtotal before holiday
        const subtotal = total / (1 + pct / 100);
        const holidayFee = total - subtotal;
        lines.push(`  Holiday/Weekend: ${pct}% = $${holidayFee.toFixed(2)}`);
      }

      const quoteNotesText = document.getElementById('quoteNotes').value.trim();

      if (hasSurcharges) lines.push('');
      if (quoteNotesText) {
        lines.push('Notes:');
        lines.push(`  ${quoteNotesText}`);
        lines.push('');
      }
      lines.push('─'.repeat(28));
      lines.push(`TOTAL: $${total.toFixed(2)}`);

      const quoteText = lines.join('\n');

      // Copy to clipboard
      copyToClipboard(quoteText).then(() => {
        const btn = document.getElementById('generateQuoteBtn');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      }).catch(() => {});

      // Save to history
      const surcharges = {};
      if (document.getElementById('detourToggle').checked)
        surcharges.detour = parseFloat(document.getElementById('detourMiles').value) || 0;
      if (document.getElementById('holidayToggle').checked)
        surcharges.holiday = true;

      const entry = {
        date: new Date().toISOString(),
        miles,
        tier,
        dogs,
        surcharges,
        total,
        quoteText,
        notes: quoteNotesText || null,
        status: null,
        origin: originName || null,
        destination: destName || null
      };

      // Store customer names from dogs for history display
      if (customerNames.length > 0) {
        entry.customerName = customerNames.join(', ');
      }

      let history = [];
      try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) {}
      history.unshift(entry);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));

      // Prompt to save new customers not already in the customer list
      const existingCustomers = loadCustomers();
      const newNames = customerNames.filter(name =>
        !existingCustomers.find(c => c.name.toLowerCase() === name.toLowerCase())
      );
      if (newNames.length > 0) {
        showNewCustomerModal(newNames.join(', '), (saved) => {
          if (saved) {
            newNames.forEach(name => addCustomer(name, ''));
          }
        });
      }
    });

    // ===================== HISTORY =====================
    function renderHistory() {
      let history = [];
      try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) {}
      const list = document.getElementById('historyList');
      const empty = document.getElementById('historyEmpty');
      const searchQuery = (document.getElementById('historySearch').value || '').trim().toLowerCase();

      // Clear existing cards (keep empty state element)
      list.querySelectorAll('.history-card').forEach(c => c.remove());

      const clearBtn = document.getElementById('clearHistoryBtn');
      if (history.length === 0) {
        empty.style.display = '';
        clearBtn.style.display = 'none';
        return;
      }

      // Filter by search
      let filtered = history;
      if (searchQuery) {
        filtered = history.filter(entry => {
          const name = (entry.customerName || '').toLowerCase();
          const dateStr = new Date(entry.date).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
          }).toLowerCase();
          const origin = (entry.origin || '').toLowerCase();
          const dest = (entry.destination || '').toLowerCase();
          const notes = (entry.notes || '').toLowerCase();
          const status = (entry.status || '').toLowerCase();
          return name.includes(searchQuery) || dateStr.includes(searchQuery) ||
                 origin.includes(searchQuery) || dest.includes(searchQuery) ||
                 notes.includes(searchQuery) || status.includes(searchQuery);
        });
      }

      if (filtered.length === 0) {
        empty.style.display = '';
        empty.textContent = searchQuery ? 'No matching quotes' : 'No quotes yet';
        clearBtn.style.display = history.length > 0 ? '' : 'none';
        return;
      }
      empty.style.display = 'none';
      clearBtn.style.display = '';

      filtered.forEach((entry) => {
        // Find index in original history for updates
        const histIdx = history.indexOf(entry);

        const card = document.createElement('div');
        card.className = 'history-card';
        const d = new Date(entry.date);
        const dateStr = d.toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        });
        const dogSummary = entry.dogs.map(dog => {
          const sizeLabel = {S:'Small',M:'Medium',L:'Large',XL:'XL'}[dog.size] || dog.size;
          return sizeLabel + (dog.isLitter ? ` (litter x${dog.siblingCount})` : '');
        }).join(', ');

        if (entry.customerName) {
          const custDiv = document.createElement('div');
          custDiv.className = 'history-card-customer';
          custDiv.textContent = entry.customerName;
          card.appendChild(custDiv);
        }

        const dateDiv = document.createElement('div');
        dateDiv.className = 'history-card-date';
        dateDiv.textContent = dateStr;

        // Status pill (cycles on tap: none → sent → accepted → declined → none)
        if (entry.status) {
          const pill = document.createElement('span');
          pill.className = `status-pill status-pill-${entry.status}`;
          pill.textContent = entry.status.charAt(0).toUpperCase() + entry.status.slice(1);
          pill.addEventListener('click', (e) => {
            e.stopPropagation();
            cycleStatus(histIdx);
          });
          dateDiv.appendChild(pill);
        } else {
          const pill = document.createElement('span');
          pill.className = 'status-pill status-pill-none';
          pill.textContent = 'Status';
          pill.addEventListener('click', (e) => {
            e.stopPropagation();
            cycleStatus(histIdx);
          });
          dateDiv.appendChild(pill);
        }

        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'history-card-summary';
        let summaryText = `${entry.miles} mi · ${entry.tier === 'vip' ? 'VIP' : 'Economy'} · ${dogSummary}`;
        if (entry.origin && entry.destination) {
          const from = entry.origin.split(',')[0];
          const to = entry.destination.split(',')[0];
          summaryText = `${from} → ${to} · ${summaryText}`;
        }
        summaryDiv.textContent = summaryText;

        const totalDiv = document.createElement('div');
        totalDiv.className = 'history-card-total';
        totalDiv.textContent = '$' + entry.total.toFixed(2);

        // Re-quote (always visible, bottom-right)
        const requoteBtn = document.createElement('button');
        requoteBtn.type = 'button';
        requoteBtn.className = 'history-requote-btn';
        requoteBtn.textContent = 'Re-quote';
        requoteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          loadQuoteIntoCalculator(entry);
        });

        const quoteDiv = document.createElement('div');
        quoteDiv.className = 'history-card-quote';
        quoteDiv.textContent = entry.quoteText || '';

        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'history-copy-btn';
        copyBtn.textContent = 'Copy Quote';

        card.appendChild(dateDiv);
        card.appendChild(summaryDiv);
        card.appendChild(totalDiv);
        // Notes preview (after total, before re-quote)
        if (entry.notes) {
          const notesDiv = document.createElement('div');
          notesDiv.className = 'history-card-notes';
          notesDiv.textContent = entry.notes;
          card.appendChild(notesDiv);
        }
        card.appendChild(requoteBtn);
        card.appendChild(quoteDiv);
        card.appendChild(copyBtn);

        card.addEventListener('click', (e) => {
          if (e.target.closest('.status-pill') || e.target === copyBtn || e.target === requoteBtn) return;
          quoteDiv.classList.toggle('visible');
          copyBtn.classList.toggle('visible');
        });

        copyBtn.addEventListener('click', () => {
          copyToClipboard(entry.quoteText || '').then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'Copy Quote'; }, 1500);
          }).catch(() => {});
        });

        list.appendChild(card);
      });
    }

    // Search handler
    document.getElementById('historySearch').addEventListener('input', renderHistory);

    function cycleStatus(histIdx) {
      const order = [null, 'sent', 'accepted', 'declined'];
      let h = [];
      try { h = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) {}
      if (histIdx < 0 || histIdx >= h.length) return;
      const current = h[histIdx].status || null;
      const nextIdx = (order.indexOf(current) + 1) % order.length;
      h[histIdx].status = order[nextIdx];
      localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
      renderHistory();
    }

    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      localStorage.removeItem(HISTORY_KEY);
      document.getElementById('historySearch').value = '';
      renderHistory();
    });

    // ===================== RE-QUOTE =====================
    function loadQuoteIntoCalculator(entry) {
      // Route / miles
      if (entry.origin) {
        document.getElementById('originInput').value = entry.origin;
      } else {
        document.getElementById('originInput').value = '';
      }
      if (entry.destination) {
        document.getElementById('destInput').value = entry.destination;
      } else {
        document.getElementById('destInput').value = '';
      }
      // Clear stops
      originCoords = null;
      destCoords = null;
      stopCoords = [];
      document.getElementById('stopsContainer').innerHTML = '';
      updateAddStopBtn();
      document.getElementById('routeSummary').classList.remove('visible');

      // Set miles manually
      milesMode = 'manual';
      document.getElementById('milesModeBtn').textContent = 'Auto';
      document.getElementById('manualMilesRow').classList.add('visible');
      document.getElementById('milesInput').value = entry.miles || '';
      document.getElementById('milesValue').textContent = entry.miles || '0';

      // Tier
      const tierControl = document.getElementById('tierControl');
      tierControl.querySelectorAll('.segment').forEach(s => {
        s.classList.toggle('active', s.dataset.tier === entry.tier);
      });

      // Dogs — clear and recreate
      document.getElementById('dogEntries').innerHTML = '';
      dogCounter = 0;
      if (entry.dogs && entry.dogs.length > 0) {
        entry.dogs.forEach(dog => {
          const dogEl = createDogEntry();
          // Set customer
          if (dog.customer) {
            const custInput = dogEl.querySelector('.customer-input');
            if (custInput) custInput.value = dog.customer;
          }
          // Set size
          dogEl.querySelectorAll('.size-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.size === dog.size);
          });
          // Set litter
          if (dog.isLitter) {
            const litterToggle = dogEl.querySelector('.litter-toggle');
            litterToggle.checked = true;
            const idx = dogEl.dataset.dogId;
            dogEl.querySelector(`[data-litter-options="${idx}"]`).classList.add('visible');
            // Siblings
            const siblingsEl = dogEl.querySelector('.stepper-value');
            siblingsEl.textContent = dog.siblingCount || 1;
            // Age
            dogEl.querySelectorAll('.age-btn').forEach(b => {
              b.classList.toggle('active', b.dataset.age === dog.age);
            });
          }
        });
      } else {
        createDogEntry();
      }

      // Surcharges
      document.getElementById('detourToggle').checked = false;
      document.getElementById('detourDetail').classList.remove('visible');
      document.getElementById('detourMiles').value = '';
      document.getElementById('holidayToggle').checked = false;
      // Collapse surcharges
      document.getElementById('surchargesHeader').classList.remove('expanded');
      document.getElementById('surchargesContent').classList.remove('visible');

      if (entry.surcharges) {
        const s = entry.surcharges;
        if (s.detour !== undefined) {
          document.getElementById('detourToggle').checked = true;
          document.getElementById('detourDetail').classList.add('visible');
          document.getElementById('detourMiles').value = s.detour;
          document.getElementById('surchargesHeader').classList.add('expanded');
          document.getElementById('surchargesContent').classList.add('visible');
        }
        if (s.holiday) {
          document.getElementById('holidayToggle').checked = true;
          document.getElementById('surchargesHeader').classList.add('expanded');
          document.getElementById('surchargesContent').classList.add('visible');
        }
      }

      // Notes
      document.getElementById('quoteNotes').value = entry.notes || '';
      document.getElementById('quoteNotesCount').textContent = (entry.notes || '').length + ' / 500';

      // Switch to calculator and recalculate
      switchScreen('calculator');
      recalculate();
    }

    // ===================== CUSTOMERS SCREEN =====================
    let currentCustomerId = null;

    function showCustomerList() {
      document.getElementById('customerListView').style.display = '';
      document.getElementById('customerDetailView').classList.remove('visible');
    }

    function showCustomerDetail(id) {
      currentCustomerId = id;
      const customers = loadCustomers();
      const c = customers.find(c => c.id === id);
      if (!c) return;

      document.getElementById('customerListView').style.display = 'none';
      document.getElementById('customerDetailView').classList.add('visible');
      document.getElementById('customerDetailTitle').textContent = c.name || 'Customer';
      document.getElementById('customerDetailName').value = c.name;
      document.getElementById('customerDetailNotes').value = c.notes || '';

      // Render customer's quotes
      const quotesCard = document.getElementById('customerQuotesCard');
      const quotesEmpty = document.getElementById('customerQuotesEmpty');
      // Remove old items
      quotesCard.querySelectorAll('.customer-history-item').forEach(el => el.remove());

      let history = [];
      try { history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) {}
      const custName = c.name.toLowerCase();
      const customerQuotes = history.filter(h =>
        h.customerId === id ||
        (h.dogs && h.dogs.some(d => (d.customer || '').toLowerCase() === custName)) ||
        (h.customerName || '').toLowerCase().includes(custName)
      );

      if (customerQuotes.length === 0) {
        quotesEmpty.style.display = '';
      } else {
        quotesEmpty.style.display = 'none';
        customerQuotes.forEach(entry => {
          const item = document.createElement('div');
          item.className = 'customer-history-item';
          item.style.padding = '10px 16px';

          const d = new Date(entry.date);
          const dateStr = d.toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
          });

          const dateEl = document.createElement('div');
          dateEl.className = 'customer-history-date';
          dateEl.textContent = dateStr;

          const summaryEl = document.createElement('div');
          summaryEl.className = 'customer-history-summary';
          summaryEl.textContent = `${entry.miles} mi · ${entry.tier === 'vip' ? 'VIP' : 'Economy'}`;

          const totalEl = document.createElement('div');
          totalEl.className = 'customer-history-total';
          totalEl.textContent = '$' + entry.total.toFixed(2);

          item.appendChild(dateEl);
          item.appendChild(summaryEl);
          item.appendChild(totalEl);
          quotesCard.appendChild(item);
        });
      }

      // Scroll to top
      const screen = document.querySelector('.screen[data-screen="customers"]');
      if (screen) screen.scrollTop = 0;
    }

    function renderCustomerList() {
      const customers = loadCustomers();
      const list = document.getElementById('customerList');
      const empty = document.getElementById('customersEmpty');

      // Remove old cards
      list.querySelectorAll('.card').forEach(el => el.remove());

      if (customers.length === 0) {
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      // Sort by name
      customers.sort((a, b) => a.name.localeCompare(b.name));

      const card = document.createElement('div');
      card.className = 'card';

      customers.forEach(c => {
        const item = document.createElement('div');
        item.className = 'customer-list-item';

        const nameEl = document.createElement('div');
        nameEl.className = 'customer-list-name';
        nameEl.textContent = c.name;

        item.appendChild(nameEl);

        if (c.notes) {
          const notesEl = document.createElement('div');
          notesEl.className = 'customer-list-notes';
          notesEl.textContent = c.notes;
          item.appendChild(notesEl);
        }

        item.addEventListener('click', () => showCustomerDetail(c.id));
        card.appendChild(item);
      });

      list.appendChild(card);
    }

    // Add customer button
    document.getElementById('addCustomerBtn').addEventListener('click', () => {
      const name = prompt('Customer name:');
      if (!name || !name.trim()) return;
      const c = addCustomer(name.trim(), '');
      renderCustomerList();
      showCustomerDetail(c.id);
    });

    // Back button
    document.getElementById('customerBackBtn').addEventListener('click', () => {
      // Save any edits
      if (currentCustomerId) {
        const name = document.getElementById('customerDetailName').value.trim();
        const notes = document.getElementById('customerDetailNotes').value;
        if (name) {
          updateCustomer(currentCustomerId, name, notes);
        }
      }
      renderCustomerList();
      showCustomerList();
    });

    // Save customer edits on blur
    document.getElementById('customerDetailName').addEventListener('blur', () => {
      if (!currentCustomerId) return;
      const name = document.getElementById('customerDetailName').value.trim();
      const notes = document.getElementById('customerDetailNotes').value;
      if (name) updateCustomer(currentCustomerId, name, notes);
    });

    document.getElementById('customerDetailNotes').addEventListener('blur', () => {
      if (!currentCustomerId) return;
      const name = document.getElementById('customerDetailName').value.trim();
      const notes = document.getElementById('customerDetailNotes').value;
      if (name) updateCustomer(currentCustomerId, name, notes);
    });

    // Delete customer
    document.getElementById('deleteCustomerBtn').addEventListener('click', () => {
      if (!currentCustomerId) return;
      if (!confirm('Delete this customer?')) return;
      deleteCustomer(currentCustomerId);
      currentCustomerId = null;
      renderCustomerList();
      showCustomerList();
    });

    // ===================== NEW CUSTOMER MODAL =====================
    let newCustomerModalCallback = null;

    function showNewCustomerModal(name, callback) {
      newCustomerModalCallback = callback;
      document.getElementById('newCustomerModalName').textContent = `"${name}" is not in your customer list.`;
      document.getElementById('newCustomerModal').classList.add('visible');
    }

    document.getElementById('newCustomerModalCancel').addEventListener('click', () => {
      document.getElementById('newCustomerModal').classList.remove('visible');
      if (newCustomerModalCallback) newCustomerModalCallback(false);
      newCustomerModalCallback = null;
    });

    document.getElementById('newCustomerModalSave').addEventListener('click', () => {
      document.getElementById('newCustomerModal').classList.remove('visible');
      if (newCustomerModalCallback) newCustomerModalCallback(true);
      newCustomerModalCallback = null;
    });

    // ===================== RESET DEFAULTS =====================
    document.getElementById('resetDefaultsBtn').addEventListener('click', resetDefaults);

    // ===================== INIT =====================
    loadSettings();
    createDogEntry();  // Auto-add first dog
    recalculate();
  </script>
</body>
</html>